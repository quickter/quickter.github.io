<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Bestiary</title>
		<meta name="author" content="Cole">
		<meta name="keywords" content="dnd,5e,dungeons,dragons,monsters,creatures,beasts">
		<meta name="description" content="Bestiary">
		<script src="data/bestiary.js"></script>
		<script src="src/library.js"></script>
		<script src="src/sort.js"></script>
		
		<script type="text/javascript">
			'use strict';
			
			function parseMonster(master, lookup) {
				var render = new Object()
				var filter = new Object()
				var key, item, index, value, array, prefix, suffix, name, tag
				var style, styles = []
				
				render.key = libraryKey(master.name)
				filter.key = render.key
				render.name = master.name.replace(/'/g, "’")
				render.namekey = master.name.replace(/['‘’]/g, '')
				filter.name = master.name
				render.page = master.page || false
				filter.page = master.page || 0
				
				////////// Source
				var source = master.source
				
				if ( typeof source === 'string' ) {
					render.artwork = "img/" + encodeURIComponent(source) + "/" + encodeURIComponent(libraryStripDiacriticals(master.name)).replace(/'/g, "%27") + ".png"
				} else {
					render.artwork = ""
				}
				
				if ( typeof source === 'string' && source.indexOf('UA') === 0 ) { source = 'UA' }
				
				value = lookup.sources[source]
				
				if ( value ) {
					render.source = value.key
					render.sourcename = value.name
					filter.sources = [value.key, libraryKey(value.name)]
				} else {
					render.source = source
					render.sourcename = source
					filter.sources = [source]
				}
				
				render.sourcename = render.sourcename.replace(/'/g, "’")
				
				////////// Type
				var typeTags, type = master.type
				
				if ( typeof type === 'string' ) {
					typeTags = false
					type = type
				} else if ( type && type.type ) {
					if ( type.swarmSize ) {
						filter.isSwarm = true
					}
					
					typeTags = type.tags
					type = type.type
				} else {
					typeTags = false
					type = "?"
				}
				
				if ( lookup.monstertypes[type] ) {
					value = lookup.monstertypes[type]
					
					render.type = value.key
					render.typename = value.name.toLowerCase()
					render.typeconcise = value.abbreviation
				} else {
					render.type = type
					render.typename = type.toLowerCase()
					render.typeconcise = "?"
				}
				
				filter.type = render.typename
				filter.typeTags = []
				
				if ( typeof typeTags === 'string' ) {
					render.typetags = " (" + typeTags + ")"
					filter.typeTags.push(libraryKey(typeTags))
				} else if ( typeTags && Array.isArray(typeTags) && typeTags.length > 0 ) {
					array = []
					
					for ( value of typeTags ) {
						if ( typeof value === 'string' ) {
							array.push(value)
							filter.typeTags.push(libraryKey(value))
						} else if ( typeof value.tag === 'string' ) {
							array.push(value.tag)
							filter.typeTags.push(libraryKey(value.tag))
						}
					}
					
					render.typetags = " (" + array.join(", ") + ")"
				} else {
					render.typetags = ""
				}
				
				////////// Size
				var size = master.size
				
				if ( typeof size === 'string' && lookup.sizes[size] ) {
					size = lookup.sizes[size]
					
					render.size = size.key
					render.sizekey = size.order
					render.sizename = size.name
					render.sizeconcise = size.key
				} else {
					render.size = size
					render.sizekey = -1
					render.sizename = size || "?"
					render.sizeconcise = size || "?"
				}
				
				filter.size = render.sizekey
				filter.sizeName = render.sizename
				
				////////// Armor Class
				var armorclass = master.ac
				
				if ( typeof armorclass === 'string' || typeof armorclass === 'number' ) {
					render.ac = +armorclass
					render.armorclass = armorclass
				} else if ( armorclass ) {
					render.ac = 0
					array = []
					
					if ( !Array.isArray(armorclass) ) {
						armorclass = [armorclass]
					}
					
					for ( value of armorclass ) {
						if ( typeof value === 'string' || typeof value === 'number' ) {
							render.ac = +value
							array.push(value)
							continue
						}
						
						prefix = ""
						suffix = ""
						
						if ( typeof value.condition === 'string' ) {
							suffix = " " + value.condition
						}
						
						if ( typeof value.from === 'string' ) {
							prefix = " (" + value + ")"
						} else if ( Array.isArray(value.from) ) {
							prefix = " (" + value.from.join(", ") + ")"
						}
						
						if ( !render.ac || !value.condition ) {
							render.ac = value.ac
						}
						
						array.push(value.ac + prefix + suffix)
					}
					
					render.armorclass = libraryResolveReferences(array.join(", "), master)
				} else {
					render.ac = "?"
					render.armorclass = armorclass
				}
				
				filter.armorclass = +render.ac || 0
				
				////////// Hit Points
				var hitpoints = master.hp
				
				if ( typeof hitpoints === 'string' || typeof hitpoints === 'number' ) {
					render.hp = +hitpoints
					render.hitpoints = hitpoints
					render.hitpointstags = ""
				} else if ( hitpoints.average ) {
					render.hp = +hitpoints.average
					render.hitpoints = hitpoints.average
					
					if ( hitpoints.formula ) {
						render.hitpointstags = libraryResolveReferences(" ({@dice " + hitpoints.formula + "})")
					} else {
						render.hitpointstags = ""
					}
				} else if ( hitpoints.special ) {
					render.hp = "*"
					render.hitpoints = hitpoints.special
					render.hitpointstags = ""
				} else {
					render.hp = 0
					render.hitpoints = hitpoints
					render.hitpointstags = ""
				}
				
				filter.hitpoints = render.hp === "*" ? -1 : +render.hp
				
				////////// Challenge
				var challenge = master.cr
				var challengeInLair = false
				
				if ( Array.isArray(challenge) ) { challenge = challenge[0] }
				if ( challenge && challenge.lair ) { challengeInLair = challenge.lair }
				if ( challenge && challenge.cr ) { challenge = challenge.cr }
				
				if ( typeof challenge === 'string' && challenge.indexOf('/') >= 0 ) {
					challenge = challenge.split('/')
					challenge = challenge[0] / challenge[1]
				} else if ( isNaN(+challenge) ) {
					challenge = "?"
				}
				
				var experienceForChallange = [
					10, 200, 450, 700, 1100, 1800, 2300, 2900, 3900, 5000, 5900,
					7200, 8400, 10000, 11500, 13000, 15000, 18000, 20000, 22000, 25000,
					33000, 41000, 50000, 62000, 75000, 90000, 105000, 120000, 135000, 155000
				]
				
				render.challenge = challenge
				render.challengekey = challenge === "?" ? 1000 : (8 * challenge) | 0
				render.challengename = challenge === "?" ? "―" : challenge > 0 && challenge < 1 ? "0⅛¼⅜½⅝¾⅞".charAt(Math.round(challenge * 8)) : challenge
				render.challengexp = challenge > 0 && challenge < 1 ? challenge * experienceForChallange[1] : experienceForChallange[challenge | 0]
				
				//if ( ignoreErrata && type === 'dragon' && challenge >= 20 ) {
				//	var lessForDragons = [500, 5500, 11000, 17500, 25500, 0, 0, 0, 0, 0, 0]
				//	render.challengexp -= lessForDragons[challenge - 20]
				//}
				
				if ( challenge !== "?" ) {
					filter.challenge = (8 * challenge) | 0
					filter.experience = +render.challengexp
				}
				
				render.challengeexperience = challenge !== "?" ? "(" + render.challengexp + " XP)" : ""
				
				////////// Alignment
				var alignment = master.alignment
				var alignmentsTagged = 0
				filter.alignment = []
				
				if ( typeof alignment === 'string' ) {
					render.alignment = alignment
					filter.alignment.push.apply(filter.alignment, alignment.split(" "))
				} else if ( Array.isArray(alignment) ) {
					suffix = " "
					array = []
					
					var hasNX = alignment.indexOf('NX') >= 0
					var hasNY = alignment.indexOf('NY') >= 0
					
					if ( hasNX || hasNY ) {
						array.push("Any")
					}
					
					if ( hasNX && hasNY ) {
						var missing = ["L", "C", "G", "E"].filter(function(a) { return alignment.indexOf(a) < 0 })[0]
						
						array.push("Non-" + lookup.alignments[missing].name)
					} else if ( hasNX ) {
						array.push(lookup.alignments[alignment[alignment.length - 1]].name)
					} else if ( hasNY ) {
						array.push(lookup.alignments[alignment[0]].name)
					} else {
						for ( value of alignment ) {
							if ( typeof value === 'string' ) {
								if ( lookup.alignments[value] ) {
									if ( alignment.length === 1 && value !== 'U' ) {
										array.push("Any")
									}
								
									array.push(lookup.alignments[value].name)
								} else {
									array.push(value)
								}
							} else if ( typeof value.special === 'string' ) {
								array.push(value.special)
							} else if ( value.alignment && value.chance ) {
								array.push(value.alignment.map(function (a) { return lookup.alignments[a].name }).join(" ") + " (" + value.chance + "%)")
								suffix = " or "
							}
						}
					}
					
					if ( hasNX || hasNY ) {
						array.push("Alignment")
					}
					
					for ( value of alignment ) {
						if ( typeof value === 'string' ) {
							if ( value === 'A' ) {
								filter.alignment.push('any')
								alignmentsTagged += 1
							} else {
								value = value.slice(0, 1)
								
								if ( lookup.alignments[value] ) {
									filter.alignment.push(lookup.alignments[value].name)
									alignmentsTagged += 1
								}
							}
						} else if ( typeof value.special === 'string' ) {
							filter.alignment.push('special')
							alignmentsTagged += 1
						} else if ( value.alignment ) {
							for ( value of value.alignment ) {
								value = value.slice(0, 1)
								
								if ( lookup.alignments[value] ) {
									filter.alignment.push(lookup.alignments[value].name)
									alignmentsTagged += 1
								}
							}
						}
					}
					
					render.alignment = array.join(suffix).toLowerCase()
				} else {
					render.alignment = "Unknown"
					filter.alignment.push('unknown')
				}
				
				////////// Speed
				var speed = master.speed
				var units = " ft."
				filter.movement = []
				filter.speed = 0
				
				if ( typeof speed === 'string' || typeof speed === 'number' ) {
					render.speed = speed + units
					filter.walk = +speed || 0
					filter.movement.push('walk')
					filter.speed = Math.max(filter.speed, filter.walk)
				} else if ( speed ) {
					var keysForSpeed = ['walk', 'burrow', 'climb', 'fly', 'swim']
					array = []
					
					for ( key of keysForSpeed ) {
						value = speed[key]
						prefix = key !== 'walk' ? key + " " : ""
						
						if ( typeof value === 'string' || typeof value === 'number' ) {
							array.push(prefix + value + units)
							filter[key] = +value || 0
							filter.movement.push(key)
							filter.speed = Math.max(filter.speed, filter[key])
						} else if ( value && value.number ) {
							suffix = value.condition ? (value.condition.charAt(0) === " " ? "" : " ") + value.condition + "" : ""
							array.push(prefix + value.number + units + suffix)
							filter[key] = +value.number || 0
							filter.movement.push(key)
							filter.speed = Math.max(filter.speed, filter[key])
							
							if ( value.condition === '(hover)' ) {
								filter.movement.push('hover')
							}
						}
					}
					
					render.speed = array.join(", ")
				} else {
					render.speed = "?"
				}
				
				////////// Attributes
				var keysForAttributes = ['str=Strength', 'dex=Dexterity', 'con=Constitution', 'int=Intelligence', 'wis=Wisdom', 'cha=Charisma']
				suffix = "modifier"
				
				for ( key of keysForAttributes ) {
					index = key.indexOf('=')
					
					if ( index < 0 ) {
						name = key
					} else {
						name = key.slice(index + 1)
						key = key.slice(0, index)
					}
					
					value = master[key]
					key = name.toLowerCase()
					prefix = name.slice(0, 3)
					
					if ( typeof value === 'string' || typeof value === 'number' ) {
						render[key] = value
						render[key + suffix] = (value < 10 ? "" : "+") + (Math.floor(value / 2) - 5)
						filter[key] = +value || 0
					} else {
						render[key] = ""
						render[key + suffix] = 0
					}
				}
				
				////////// Saves
				var save = master.save
				array = []
				filter.saves = []
				suffix = "Save"
				
				if ( save ) {
					for ( key of keysForAttributes ) {
						index = key.indexOf('=')
						
						if ( index < 0 ) {
							name = key
						} else {
							name = key.slice(index + 1)
							key = key.slice(0, index)
						}
						
						value = save[key]
						key = name.toLowerCase()
						prefix = name.slice(0, 3)
						
						if ( typeof value === 'string' || typeof value === 'number' ) {
							array.push(prefix + " " + value)
							filter[key + suffix] = +value || 0
							filter.saves.push(name)
						}
					}
				}
				
				render.savingthrows = array.join(", ")
				
				////////// Skills
				var keysForSkill = [
					'Acrobatics', 'Animal Handling', 'Arcana', 'Athletics', 'Deception',
					'History', 'Insight', 'Intimidation', 'Investigation', 'Medicine',
					'Nature', 'Perception', 'Performance', 'Persuasion', 'Religion',
					'Sleight of Hand', 'Stealth', 'Survival'
				]
				var skill = master.skill
				array = []
				filter.skills = []
				
				if ( skill ) {
					for ( key of keysForSkill ) {
						value = skill[key.toLowerCase()]
						
						if ( typeof value === 'string' || typeof value === 'number' ) {
							array.push(key + libraryResolveReferences(" {@dice d20" + value + "|" + value + "}"))
							filter.skills.push(key)
						}
					}
				}
				
				array.sort()
				render.skills = array.join(", ")
				
				////////// Resistances
				var keysForResistances = [
					'vulnerable=vulnerabilities', 'resist=resistances', 'immune=immunities',
					'conditionImmune=unconditionals', 'senses', 'languages'
				]
				
				for ( key of keysForResistances ) {
					index = key.indexOf('=')
					
					if ( index < 0 ) {
						prefix = key
					} else {
						prefix = key.slice(index + 1)
						key = key.slice(0, index)
					}
					
					filter[prefix] = []
					value = master[key]
					
					if ( typeof value === 'string' ) {
						render[prefix] = value
						filter[prefix].push(value)
					} else if ( Array.isArray(value) ) {
						array = []
						
						for ( item of value ) {
							if ( typeof item === 'string' ) {
								array.push(item)
								filter[prefix].push(item)
							} else if ( item[key] && Array.isArray(item[key]) ) {
								array.push(item[key].join(", ") + (item.note ? " " + item.note : ""))
								filter[prefix].push.apply(filter[prefix], item[key])
							}
						}
						
						render[prefix] = array.join(", ")
					} else {
						render[prefix] = ""
					}
				}
				
				value = master.passive
				
				if ( typeof value === 'string' || typeof value === 'number' ) {
					render.senses = render.senses + (render.senses.length > 0 ? ", " : "") + "passive Perception " + value
					filter.passivePerception = +value || 0
				}
				
				////////// Languages
				if ( render.languages === '' ) {
					render.languages = "―"
				}
				
				var language, languages = master.languages
				
				if ( typeof languages === 'string' ) {
					languages = languages.split(',')
				} else if ( Array.isArray(languages) ) {
					array = []
					
					for ( language of languages ) {
						if ( language.indexOf('understands') < 0 ) {
							language = language.replace(/ \(can.*\)$/g, '')
							language = language.replace(/ plus .*/g, '')
							language = language.replace(/ and (one|the) .*/g, '')
							language = language.replace(/and (.*) but .*/g, '$1')
							language = language.replace(/ but .*/g, '')
							language = language.replace(/,? and /g, ', ')
							
							if ( language.charCodeAt(0) < 0x60 ) {
								array.push(language)
							} else if ( language === 'all' ) {
								array.push('all')
							} else if ( language.indexOf('telepathy') >= 0 ) {
								array.push('telepathy')
							}
						} else {
							language = language.replace(/,? and /g, ', ')
							language = language.replace(/understands (.*) but .*/g, '$1')
							language = language.replace(/understands /g, '')
							
							for ( language of language.split(', ') ) {
								if ( language.charCodeAt(0) < 0x60 ) {
									array.push(language)
								} else if ( language === 'all' || language === 'all languages' ) {
									array.push('all')
								}
							}
						}
					}
					
					if ( languages.length && !array.length ) {
						array.push('some')
					}
					
					languages = array
				} else {
					languages = []
				}
				
				filter.languages = languages.map(libraryKey)
				
				if ( !languages.length ) { languages.push('none') }
				render.languageList = languages.join(", ")
				
				////////// Environments
				var environments = master.environment
				
				if ( typeof environments === 'string' ) {
					render.environments = libraryResolveReferences(environments, master)
					filter.environments = environments.split(',')
				} else if ( Array.isArray(environments) ) {
					array = [].concat(environments)
					array.sort()
					render.environments = array.join(", ")
					filter.environments = array
				} else {
					render.environments = ""
					filter.environments = []
				}
				
				////////// Tags
				filter.isFamiliar = !!master.familiar
				filter.isLegendary = !!(master.legendary || master.traitTags && master.traitTags.indexOf("Legendary Resistances") >= 0)
				
				if ( master.actionTags && master.actionTags.indexOf("Multiattack") >= 0 ) {
					filter.hasMultipleAttacks = true
				} else if ( Array.isArray(master.action) && master.action[0].name && master.action[0].name.indexOf("Multiattack") === 0 ) {
					filter.hasMultipleAttacks = true
				}
				
				filter.actions = []
				if ( Array.isArray(master.actionTags) ) {
					filter.actions.push.apply(filter.actions, master.actionsTags)
				}
				
				filter.traits = []
				if ( Array.isArray(master.traitTags) ) {
					filter.traits.push.apply(filter.traits, master.traitTags)
				}
				
				filter.sights = []
				if ( Array.isArray(master.senseTags) ) {
					for ( value of master.senseTags ) {
						filter.sights.push({'B':'blind', 'U':'true', 'D':'dark', 'SD':'dark', 'T':'tremor'}[value] || value)
					}
				}
				
				////////// Description
				var cardinality = ["th", "st", "nd", "rd", "th", "th", "th", "th", "th", "th"]
				var legendary = "The {=name} can take 3 legendary actions, choosing from the options below. Only one legendary action option can be used at a time and only at the end of another creature's turn. The {=name} regains spent legendary actions at the start of its turn."
				var keysForText = ['trait', 'action=Actions', 'reaction=Reactions', 'legendary=Legendary Actions', 'variant=Variant']
				var spellcasting = master.spellcasting
				var spells
				array = []
				
				filter.spellcastingAbility = false
				
				for ( key of keysForText ) {
					index = key.indexOf('=')
					
					if ( index < 0 ) {
						prefix = ""
					} else {
						prefix = key.slice(index + 1)
						key = key.slice(0, index)
					}
					
					value = master[key]
					
					if ( !value && key === 'trait' && spellcasting ) {
						value = []
					}
					
					if ( value ) {
						if ( prefix ) {
							array.push("<span class='monster-title'>" + prefix + "</span><hr class='monster-thin' />")
						}
						
						if ( key === 'legendary' ) {
							array.push("<p>" + legendary + "</p>")
						}
						
						array.push(libraryResolveEntries(value, "<p>", "</p>"))
						
						if ( key === 'trait' && spellcasting ) {
							if ( !Array.isArray(spellcasting) ) {
								spellcasting = [spellcasting]
							}
							
							for ( item of spellcasting ) {
								filter.spellcastingAbility = item.ability || false
								spells = []
								
								if ( Array.isArray(item.will) ) {
									spells.push.apply(spells, item.will)
								}
								
								if ( item.daily ) {
									for ( index = 1 ; index < 10 ; ++index ) {
										if ( Array.isArray(item.daily[index + "e"]) ) {
											spells.push.apply(spells, item.daily[index + "e"])
										}
									}
								}
								
								if ( item.spells ) {
									for ( index = 0 ; index < 10 ; ++index ) {
										if ( item.spells["" + index] && Array.isArray(item.spells["" + index].spells) ) {
											spells.push.apply(spells, item.spells["" + index].spells)
										}
									}
								}
								
								spells = spells.map(function (spell) { return spell.replace(/[^{}]*\{@spell ([^{}|]+)\}[^{}]*/g, "$1") })
								spells = spells.map(libraryKey)
								spells.sort()
								spells = spells.join(",")
								
								if ( item.name || item.headerEntries ) {
									spells = "<a class='spellcasting spells' href='spellbook.html#" + spells + "' >" + item.name + "</a>"
									array.push(libraryResolveEntries({'name':spells, 'entries':item.headerEntries || []}, "<p class='spellcasting'>", "</p>"))
								}
								
								if ( Array.isArray(item.will) && !(item.hidden && item.hidden.indexOf('will') >= 0) ) {
									array.push("<div class='spellcasting'><span class='spells-at-will'></span><span class='spells'>" + item.will.join(", ") + "</span></div>")
								}
								
								if ( item.daily && !(item.hidden && item.hidden.indexOf('daily') >= 0) ) {
									for ( index = 1 ; index < 10 ; ++index ) {
										if ( Array.isArray(item.daily[index + 'e']) && item.daily[index + 'e'].length > 0 ) {
											array.push("<div class='spellcasting'><span class='spell" + (item.daily[index + 'e'].length > 1 ? 's' : '') + "-daily'>" + index + "</span><span class='spells'>" + item.daily[index + 'e'].join(", ") + "</span></div>")
										}
									}
								}
								
								if ( item.spells && !(item.hidden && item.hidden.indexOf('spells') >= 0) ) {
									if ( item.spells["0"] && Array.isArray(item.spells["0"].spells) && item.spells["0"].spells.length > 0 ) {
											array.push("<div class='spellcasting'><span class='spell-level-cantrip'></span><span class='spell-slots'></span><span class='spells'>" + item.spells["0"].spells.join(", ") + "</span></div>")
									}
									
									for ( index = 1 ; index < 10 ; ++index ) {
										if ( item.spells["" + index] && Array.isArray(item.spells["" + index].spells) && item.spells["" + index].spells.length > 0 ) {
											array.push("<div class='spellcasting'><span class='spell-level'>" + index + cardinality[index] + "</span><span class='spell-slots'>" + (item.spells["" + index].slots || '') + "</span><span class='spells'>" + item.spells["" + index].spells.join(", ") + "</span></div>")
										}
									}
								}
								
								if ( item.footerEntries ) {
									array.push(libraryResolveEntries(item.footerEntries, "<div class='spellcasting'>", "</div>"))
								}
							}
							
							array.push("<br/>")
						}
					}
				}
				
				render.description = array.join("")
				
				////////// Styles
				styles.push('type-' + render.typename.toLowerCase())
				styles.push('size-' + render.sizename.toLowerCase())
				styles.push('source-' + render.source.toLowerCase())
				if ( filter.typeTags.indexOf("anyrace") >= 0 ) { styles.push('is-any-race') }
				
				if ( filter.environments.length === 0 ) { styles.push('environment-none') }
				for ( value of filter.environments ) { styles.push('environment-' + value) }
				
				render.styles = styles.join(' ')
				render.description = libraryResolveReferences(render.description, master)
				render.filter = filter
				
				return render
			}
			
			function parseMonsters(bestiary) {
				var result = []
				var lookup = new Object()
				var lookupKeys = ['sources', 'sizes', 'monstertypes', 'alignments', 'abilities']
				var styles, text
				var excludeSource = ['WDH']
				var key, item, monster
				var masterList = bestiary.monster
				
				for ( key of lookupKeys ) {
					lookup[key] = new Object()
					
					if ( Array.isArray(bestiary[key]) ) {
						for ( item of bestiary[key] ) {
							lookup[key][item.key] = item
						}
					}
				}
				
				for ( monster of masterList ) {
					if ( monster['_copy'] ) {
						continue
					}
					
					if ( excludeSource.indexOf(monster['source']) >= 0 ) {
						continue
					}
					
					item = parseMonster(monster, lookup)
					
					text = [
						item.name, item.sizename, item.typename, item.typetags, item.alignment,
						"ac " + item.armorclass, "hp " + item.hitpoints, item.hitpointstags, item.speed,
						item.skills, item.vulnerabilities, item.resistances, item.immunities,
						item.unconditionals, item.senses, item.languages, "cr " + item.challengename, item.challengeexperience,
						item.description, item.environments, item.sourcename, "pg " + item.page
					]
					item.searchableText = text.join(" ")
					
					result.push(item)
				}
				
				result.sort(function (a, b) { return a.key > b.key })
				
				return result
			}
			
			function renderItem(item) {
				var host = window.localStorage.getItem('quickter.bestiary.artwork.host')
				var template = "" +
					(host ? "<img id='artwork-{key}' data-path='{artwork}' loading='lazy' class='lazy artwork' alt=''>" : "") +
					"<div class='monster-caption'><span class='size'>{sizename}</span> <span class='type'>{typename}{typetags}, </span><span class='alignment'>{alignment}</span></div>" +
					"<hr class='monster-thick' />" +
					"<div class='beside-artwork'><span class='prefix armorclass'>{armorclass}</span></div>" +
					"<div class='beside-artwork'><span class='prefix hitpoints'>{hitpoints}</span><span class='hitpointstags'>{hitpointstags}</span></div>" +
					"<div class='beside-artwork'><span class='prefix speed'>{speed}</span></div>" +
					"<hr class='monster-thick' />" +
					"<table class='abilities'><tr><th>Str</th><th>Dex</th><th>Con</th><th>Int</th><th>Wis</th><th>Cha</th></tr><tr>" +
						"<td><span class='ability-score'>{strength}</span> <span class='ability-modifier'>({strengthmodifier})</span></td>" +
						"<td><span class='ability-score'>{dexterity}</span> <span class='ability-modifier'>({dexteritymodifier})</span></td>" +
						"<td><span class='ability-score'>{constitution}</span> <span class='ability-modifier'>({constitutionmodifier})</span></td>" +
						"<td><span class='ability-score'>{intelligence}</span> <span class='ability-modifier'>({intelligencemodifier})</span></td>" +
						"<td><span class='ability-score'>{wisdom}</span> <span class='ability-modifier'>({wisdommodifier})</span></td>" +
						"<td><span class='ability-score'>{charisma}</span> <span class='ability-modifier'>({charismamodifier})</span></td>" +
					"</tr></table>" +
					"<hr class='monster-thick' />" +
					"<div><span class='prefix saves'>{savingthrows}</span></div>" +
					"<div><span class='prefix skills'>{skills}</span></div>" +
					"<div><span class='prefix vulnerabilities'>{vulnerabilities}</span></div>" +
					"<div><span class='prefix resistances'>{resistances}</span></div>" +
					"<div><span class='prefix immunities'>{immunities}</span></div>" +
					"<div><span class='prefix unconditionals'>{unconditionals}</span></div>" +
					"<div><span class='prefix senses'>{senses}</span></div>" +
					"<div><span class='prefix languages'>{languages}</span></div>" +
					"<div><span class='prefix challenge'>{challengename}</span> <span class='experience'>{challengeexperience}</span></div>" +
					"<hr class='monster-thick' />" +
					"{description}" +
					"<p class='prefix environments'>{environments}</p>" +
					"<p class='source'>{sourcename}<span class='page-number'>{page}</span></p>" +
					"<label for='toggle-{key}' class='toggle close action'>&mdash;</label>" +
					""
				
				return libraryRenderTemplateItem(template, item)
			}
			
			function renderItemTable(list) {
				var rowTemplate = "<tr id='item-{key}' class='library monster {styles}'>" +
					"<td class='selected monster-selected'><input id='select-{key}' name='select_{key}' type='checkbox' class='selection' onchange='libraryHandleSelect(\"{key}\")' /></td>" +
					"<td class='name monster-name natural' id='name-{key}' data-sort-key='{namekey}'>" +
						"<input id='toggle-{key}' name='toggle-{key}' type='checkbox' class='toggle' onchange='handleToggle(\"{key}\")' />" +
						"<label for='toggle-{key}' class='toggle'><a id='{key}' class='monster-name'>{name}</a></label>" +
						"<div class='toggled details'><div id='inner-{key}' class='inner details'>" +
						"</div></div>" +
					"</td>" +
					"<td class='monster-size natural monster-size-{sizekey}' data-sort-key='{sizekey}' title='Size {sizename}'>{size}</td>" +
					"<td class='monster-type natural' title='{typename}'><span>{typeconcise}</span></td>" +
					"<td class='monster-armorclass numeric' title='Armor Class {ac}'>{ac}</td>" +
					"<td class='monster-hitpoints numeric' title='Hit Points {hp}'>{hp}</td>" +
					"<td class='monster-challenge numeric' data-sort-key='{challengekey}' title='Challenge Rating {challengename} {challengeexperience}'>{challengename}</td>" +
					"<td class='monster-source natural' title='{sourcename} {page}'>{source}</td>" +
				"</tr>"
				
				var header = "<tr id='monster-header' class='library monster header'>" +
					"<th class='monster-selected sortable' data-sort-invert> </th>" +
					"<th class='monster-name natural sortable' data-sort-format='locale'>Name</th>" +
					"<th class='monster-size natural sortable' data-sort-format='normal' title='Size'>S</th>" +
					"<th class='monster-type natural sortable' data-sort-format='normal' title='Type'>T</th>" +
					"<th class='monster-armorclass numeric sortable' data-sort-format='number' title='Armor Class'>AC</th>" +
					"<th class='monster-hitpoints numeric sortable' data-sort-format='number' title='Hit Points'>HP</th>" +
					"<th class='monster-challenge numeric sortable' data-sort-format='number' title='Challenge Rating'>CR</th>" +
					"<th class='monster-source natural sortable' data-sort-format='normal'>From</th>" +
				"</tr>"
				
				return header + libraryRenderTemplateItemArray(rowTemplate, list).join("")
			}
			
			function handleToggle(key) {
				var element = libraryPopulateItem(key, renderItem)
				var image = libraryElement('artwork-' + key)
				
				if ( image && !image.src && image.dataset.path ) {
					var host = window.localStorage.getItem('quickter.bestiary.artwork.host')
		
					if ( host ) {
						if ( host.indexOf('/') < 0 ) { host = host + "/" }
						if ( host.indexOf(':') < 0 ) { host = "https://" + host }
			
						image.addEventListener('error', function(e) { e.target.parentNode.removeChild(e.target) })
						image.src = host + image.dataset.path
					}
				}
			}
			
			function applyParameters() {
				var object = libraryInflateParameters(null, location.search, '?', '&')
				var form = libraryForm()
				var key, value
				
				value = object['artwork']
				
				if ( value ) {
					key = 'quickter.bestiary.artwork.host'
					
					if ( value.indexOf('.') > 0 ) {
						window.localStorage.setItem(key, value)
					} else {
						window.localStorage.removeItem(key)
					}
				}
				
				value = object['f']
				
				if ( !value ) {
					value = location.search || ''
					value = value.replace(/&/g, '?')
					value = decodeURIComponent(value)
				}
				
				if ( value ) {
					form.f.value = value
					setTimeout(libraryFilterBySearch, 0, value)
				}
			}
			
			function populateLibrary(items) {
				var table = libraryPopulateTable(items, renderItemTable)
				
				tableSort(table)
			}
			
			function transformToSize(value) {
				var size, number = parseFloat(value)
				
				if ( isNaN(number) ) {
					for ( size of bestiary.sizes ) {
						if ( size.name.toLowerCase().indexOf(value) === 0 ) {
							number = size.order
							break
						}
					}
				}
				
				return number
			}
			
			function transformToChallenge(value) {
				var index = "0⅛¼⅜½⅝¾⅞".indexOf(value)
				
				if ( index > 0 ) {
					return index
				}
				
				index = value.indexOf("/")
				
				if ( index > 0 ) {
					return 8 * +value.slice(0, index) / +value.slice(index + 1)
				}
				
				return 8 * parseFloat(value)
			}
			
			function registerFilters(bestiary) {
				libraryFilterByKeyValuePatternsRegister([
					{'key':'name', 'property':'key', 'transform':libraryKey},
					{'key':'environment', 'property':'environments', 'transform':{'none':false, '!':false}},
					{'key':'size', 'isNumber':true, 'transform':transformToSize},
					{'key':'ac', 'property':'armorclass', 'isNumber':true},
					{'key':'hp', 'property':'hitpoints', 'isNumber':true},
					{'key':'cr', 'property':'challenge', 'isNumber':true, 'transform':transformToChallenge},
					{'key':'xp', 'property':'experience', 'isNumber':true},
					{'key':'type'},
					{'key':'kind', 'property':'typeTags'},
					{'key':'alignment'},
					{'key':'language', 'property':'languages', 'transform':{'none':false, '!':false}},
					{'key':'source', 'property':'sources', 'transform':libraryKey},
					{'key':'page', 'isNumber':true},
					{'key':'move', 'property':'movement'},
					{'key':'speed', 'isNumber':true},
					{'key':'swarm', 'property':'isSwarm', 'isBoolean':true, 'isHidden':true},
					{'key':'familiar', 'property':'isFamiliar', 'isBoolean':true},
					{'key':'legend', 'property':'isLegendary', 'isBoolean':true},
					{'key':'passive', 'property':'passivePerception', 'isNumber':true},
					{'key':'ignore', 'property':'unconditionals'},
					{'key':'immune', 'property':'immunities'},
					{'key':'resist', 'property':'resistances'},
					{'key':'vulnerable', 'property':'vulnerabilities'},
					{'key':'save', 'property':'saves'},
					{'key':'sight', 'property':'sights'},
					{'key':'skill', 'property':'skills'},
					{'key':'trait', 'property':'traits'},
					{'key':'action', 'property':'actions'},
					{'key':'caster', 'property':'spellcastingAbility'},
					{'key':'strength', 'property':'strength', 'isNumber':true},
					{'key':'dexterity', 'property':'dexterity', 'isNumber':true},
					{'key':'constitution', 'property':'constitution', 'isNumber':true},
					{'key':'intelligence', 'property':'intelligence', 'isNumber':true},
					{'key':'wisdom', 'property':'wisdom', 'isNumber':true},
					{'key':'charisma', 'property':'charisma', 'isNumber':true},
				])
			}
			
			function populatePage() {
				libraryForm().addEventListener('submit', libraryHandleSubmit)
				window.addEventListener('hashchange', libraryHandleHashChanged)
				
				var items = parseMonsters(bestiary)
				
				populateLibrary(items)
				registerFilters(bestiary)
				applyParameters()
				libraryHandleHashChanged()
			}
		</script>
		
		<style>
			html {
				background: #EEE;
				overflow-y: scroll;
			}
			
			body {
				-webkit-font-smoothing: antialiased;
				-webkit-touch-callout: none;
				color: #555;
				background: #FFF;
				font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
				font-size: 14px;
				line-height: 1.75;
				padding: 2em;
				margin: 0 auto;
				max-width: 50em;
			}
			
			html { background-image: linear-gradient(270deg, rgb(230, 233, 233) 0%, rgb(216, 221, 221) 100%); }
			body { position:relative; box-shadow: 0 0 0.125em rgba(0, 0, 0, 0.06); }
			
			div#controls {
				position:absolute; right:2em; top:1.5em;
				background:#F0F0F8; border-radius:1em; padding:0.25em 0.25em;
			}
			div#controls > .control:not(:last-child) { border-right:1px solid #CCC; }
			div#controls > .control {
				display:inline-block; height:1.75em; width:1em;
				padding:0 0.75em; margin:0;
				font-size:150%; text-align:center;
				background:inherit; color:inherit;
				border:none; not-border-bottom:2px solid #999;
			}
			div#controls > label { cursor:pointer; }
			div#controls > button { display:none; }
			div#controls > a { text-decoration:none; }
			
			input#library-filter { font-size:100%; max-width:98%; }
			span#library-filter-count { opacity:0.5; font-size:60%; }
			
			input.toggle, input.filter { display:none; }
			input.filter + label { text-transform:capitalize; }
			input.filter:not(:checked) + label { opacity:0.5; }
			input.toggle:not(:checked) ~ div.toggled { display:none; }
			input.toggle:not(:checked) + label + div.toggled { display:none; }
			.filter, .trivia { cursor:pointer; -webkit-tap-highlight-color:transparent; }
			
			label.trivia.disable > span { opacity:0.5; }
			label.trivia.exclude { position:relative; }
			label.trivia.exclude:after { content:""; position:absolute; left:-0.125em; right:-0.125em; bottom:30%; border-top:solid #C00 1.5px; }
			input.trivia { display:none; }
			input.trivia:not(:checked) + input.trivia + .trivia + label.trivia + label.trivia { display:none; }
			input.trivia:not(:checked) + label.trivia { display:none; }
			
			span.taper { display:inline-block; font-size:80%; }
			span.taper:first-letter { font-size:125%; }
			
			
			div.details { position:relative; white-space:normal; width:0; }
			div.details > div.details.inner { position:relative; width:40em; max-width:70vw; line-height:1.5; padding:0.5em 1em 0 1em; margin:0.5em 0; background:#FDF4E8; border:1px solid #EEE; }
			
			div.details.inner img.artwork { position:absolute; max-width:20vw; max-height:12em; right:-1em; top:2em; }
			div.details.inner img.artwork:hover { max-width:80vw; max-height:80vh; right:0em; }
			div.details.inner div.beside-artwork { max-width:60vw; }
			
			table#library-table label.toggle.close { display:none; }
			@media screen {
				table#library-table label.toggle.close { display:inline-block; position:absolute; border-radius:50%; border:0.25em solid #F8ECE0; bottom:0.375em; right:0.375em; }
				table#library-table label.toggle.close { font-size:150%; text-align:center; line-height:1.125em; width:1.125em; height:1.125em; }
				table#library-table input.toggle:checked + label.toggle > a:after { content:" ▲"; opacity:0.25; }
			}
			
			@media (max-width:420px) {
				body { font-size:2.8vmin; }
				th.monster-source, td.monster-source { display:none; }
			}
			
			td.center, th.center { text-align:center; }
			td.natural, th.natural { text-align:left; }
			td.numeric, th.numeric { text-align:right; }
			
			table#library-table { min-width:98%; padding:0; margin:1em 0 8em 0; border-spacing:0; border-collapse:collapse; }
			table#library-table tr.library { border-bottom:0.25px solid #DDD; }
			table#library-table tr.library > td, #library-table tr.library > th { vertical-align:baseline; padding:0.125em 1em 0.125em 0; }
			table#library-table a.monster-name { display:block; cursor:pointer; }
			/*	table#library-table input.toggle:checked ~ a.monster-name { font-variant:small-caps; font-weight:bold; } */
			
			@media screen {
				table#library-table tr.library > td.monster-hitpoints::before { content:"♥︎"; font-size:50%; opacity:0.25; }
				table#library-table tr.library > td.monster-challenge::before { content:"★"; font-size:50%; opacity:0.25; }
				table#library-table tr.library > td.monster-armorclass::before { content:"♦︎"; font-size:50%; opacity:0.25; }
			}
			
			table#library-table { table-layout:fixed; width:100%; }
			table#library-table tr.library > th.monster-selected { width:1.25em; }
			table#library-table tr.library > th.monster-size,
			table#library-table tr.library > th.monster-type { width:1.5em; }
			table#library-table tr.library > th.monster-armorclass,
			table#library-table tr.library > th.monster-challenge { width:2em; }
			table#library-table tr.library > th.monster-hitpoints { width:3em; }
			table#library-table tr.library > th.monster-source { width:3em; }
			
			td.monster-source { font-size:80%; }
			div.details { color:#333; }
			div.details span.entries.indent + span.entries { margin-left:1em }
			div.details dl.entries > dt { font-weight:bold; }
			div.details .entries.italic { font-style:oblique; }
			div.details .entries.bold { font-weight:bold; }
			div.details span.prominent { font-weight:bold; }
			div.details span.prominent::after { content:"."; }
			div.details table.entries { border-spacing:0; border-collapse:collapse; }
			div.details table.entries td { vertical-align:top; }
			div.details table.entries td:not(:last-of-type) { padding-right:1em; }
			div.details table.entries td:first-child { min-width:4em; white-space:nowrap; }
			div.details table.entries tr:nth-child(even) { background:#FFFAFA; }
			div.details div.monster-caption { font-style:oblique; }
			div.details a, div.details a:visited { text-decoration-color:#CCC; color:inherit; }
			p.source { font-style:oblique; color:#666; font-size:80%; }
			p.source > span.page-number:not(:empty)::before { content:" page "; }
			p.environments { color:#666; font-size:80%; }
			p.prefix.environments:not(:empty)::before { content:"Environments: "; }
			div.details table.abilities th { text-align:center; text-transform:uppercase; }
			div.details table.abilities td { text-align:center; min-width:3em; width:4em; }
			div.details table.abilities span.ability-score { font-weight:bold; }
			div.details hr.monster-thin { border:0; height:2px; background:#333; margin-top:0; }
			div.details hr.monster-thick { border:0; height:4px; background:#333; }
			div.details span.monster-title { font-variant:small-caps; font-size:125%; }
			
			span.prefix:not(:empty)::before { font-weight:bold; }
			span.prefix.armorclass:not(:empty)::before { content:"Armor Class "; }
			span.prefix.hitpoints:not(:empty)::before { content:"Hit Points "; }
			span.prefix.speed:not(:empty)::before { content:"Speed "; }
			span.prefix.saves:not(:empty)::before { content:"Saving Throws "; }
			span.prefix.skills:not(:empty)::before { content:"Skills "; }
			span.prefix.vulnerabilities:not(:empty)::before { content:"Damage Vulnerabilities "; }
			span.prefix.resistances:not(:empty)::before { content:"Damage Resistances "; }
			span.prefix.immunities:not(:empty)::before { content:"Damage Immunities "; }
			span.prefix.unconditionals:not(:empty)::before { content:"Condition Immunities "; }
			span.prefix.senses:not(:empty)::before { content:"Senses "; }
			span.prefix.languages:not(:empty)::before { content:"Languages "; }
			span.prefix.challenge:not(:empty)::before { content:"Challenge Rating "; }
			span.entries.recharge::before { content:"(Recharge " }
			span.entries.recharge:empty::after { content:"6)" }
			span.entries.recharge:not(:empty)::after { content:"—6)" }
			div.spellcasting span.spells-at-will::after { content:"At will: " }
			div.spellcasting span.spell-daily::after { content:"/day: " }
			div.spellcasting span.spells-daily::after { content:"/day each: " }
			div.spellcasting span.spell-level-cantrip::after { content:"Cantrips (at will): " }
			div.spellcasting span.spell-level::after { content:" level " }
			div.spellcasting span.spell-slots:not(:empty)::before { content:" (" }
			div.spellcasting span.spell-slots:not(:empty)::after { content:" slots): " }
			
			dl.compact > dt, dl.compact > dd { }
			
			tr.filtered { display:none; }
			th.sortable.unsorted, th.sortable.sorted-descending { cursor:s-resize; }
			th.sortable.sorted-ascending { cursor:n-resize; }
			th.sortable.sorted-descending { text-decoration:overline; }
			th.sortable.sorted-ascending { text-decoration:underline; }
			
			.action { cursor:pointer; }
			
			@media screen {
				div.details hr.monster-thin,
				div.details hr.monster-thick { background:#933; background-image:linear-gradient(90deg, #933 0%, #C98 70%, #F8F0E6 100%); }
				div.details > div.details.inner { background-image:linear-gradient(157.5deg, #F0EAE0 0%, #F7EFE4 30%, #FDF4E8 100%); }
				
				div.details span.monster-title,
				div.details table.abilities th,
				div.details table.abilities span.ability-score,
				span.prefix:not(:empty)::before { color:#633; }
				
				div.details table.entries tr.rolled { background:#DEF; }
				div.details span.entries.action { text-decoration:underline; text-decoration-color:#CAA; }
				div.details span.rolled { color:#666; font-weight:normal; font-style:normal; }
				div.details span.rolled-success { color:#696; text-decoration-color:inherit; }
				div.details span.rolled-failure { color:#966; text-decoration-color:inherit; }
			}
			
			@media screen and (hover) and (color) {
				table#library-table.emoji tr.library th.monster-type { padding-left:0.375em; }
				table#library-table.emoji tr.library td.monster-type > span { display:none; }
				table#library-table.emoji tr.library td.monster-type::after { opacity:0.75; }
				table#library-table.emoji tr.library.type-aberration td.monster-type::after { content:"👽"; }
				table#library-table.emoji tr.library.type-beast td.monster-type::after { content:"🐺"; }
				table#library-table.emoji tr.library.type-celestial td.monster-type::after { content:"🦄"; }
				table#library-table.emoji tr.library.type-construct td.monster-type::after { content:"👤"; }
				table#library-table.emoji tr.library.type-dragon td.monster-type::after { content:"🐉"; }
				table#library-table.emoji tr.library.type-elemental td.monster-type::after { content:"🔥"; }
				table#library-table.emoji tr.library.type-fiend td.monster-type::after { content:"👺"; }
				table#library-table.emoji tr.library.type-fey td.monster-type::after { content:"🧚"; }
				table#library-table.emoji tr.library.type-giant td.monster-type::after { content:"🗿"; }
				table#library-table.emoji tr.library.type-humanoid td.monster-type::after { content:"🧝"; }
				table#library-table.emoji tr.library.type-monstrosity td.monster-type::after { content:"🦂"; }
				table#library-table.emoji tr.library.type-plant td.monster-type::after { content:"🌿"; }
				table#library-table.emoji tr.library.type-ooze td.monster-type::after { content:"🦠"; }
				table#library-table.emoji tr.library.type-undead td.monster-type::after { content:"🧟"; }
			}
			
			@media print {
				th.monster-selected, td.monster-selected { display:none; }
				div.filtering, div#controls { display:none; }
				div.details span.rolled { display:none; }
				p.source { page-break-after:always; }
			}
			
			.nose, .reroll, .action {
				-webkit-touch-callout:none;
				-webkit-user-select:none;
				-moz-user-select:none;
				-ms-user-select:none;
				-o-user-select:none;
				user-select:none;
			}
		</style>
	</head>
	<body onload='populatePage()'>
		<h4>Bestiary</h4>
		
		<div id='library-content-list'>
			<form id='library-form'>
				<div id='controls'>
					<button type='reset' id='library-reset' title='Show all spells'></button>
					<label for='library-reset' class='control'>↻</label>
					<a id='share-selection' class='control' href='' title='Share selection'>⇧</a>
				</div>
				
				<div class='filtering'>
					<input type='checkbox' id='select-all' name='a' onclick='libraryChooseUnfiltered(checked ? 1 : -1)' title='Tap to select matches.' />
					<label for='select-all'>&nbsp;</label>
					<input type='search' id='library-filter' name='f' autocomplete='off' size='36' placeholder='Filter' oninput='libraryHandleSearch(event)'>
					<span id='library-filter-count' class='action' onclick='libraryToggleUnfiltered()' title='Number of matches.  Tap to expand.'></span>
				</div>
				
				<table id='library-table' class='emoji'><tr><td>Loading...</td></tr></table>
			</form>
		</div>
	</body>
</html>
