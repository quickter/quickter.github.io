<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Dice</title>
		<meta name="author" content="Cole">
		<meta name="keywords" content="dnd,5e,dungeons,dragons,dice">
		<meta name="description" content="Dice">
		<script src="src/parseattack.js"></script>
		
		<script type="text/javascript">
			'use strict';
			
			function _element(id) {
				if ( id && Node.ELEMENT_NODE === id.nodeType ) return id;
				else if ( 'body' === id || 'head' === id ) return document[id];
				else return document.getElementById(id);
			}
			
			function _assignClass(element, c) {
				var result = 0;
				var action = ( arguments.length > 2 ) ? arguments[2] || 0 : 1
				
				if ( element.classList && 'function' === typeof element.classList.contains ) {
					if ( !(action > 0 || action < 0) ) {
						result = element.classList.toggle(c) ? 1 : -1
					} else if ( element.classList.contains(c) ) {
						result = !( action > 0 ) ? element.classList.remove(c) || -1 : 0
					} else {
						result = !( action < 0 ) ? element.classList.add(c) || 1 : 0
					}
				} else if ( element.className && 'function' === typeof element.className.search ) {
					var pattern = new RegExp('(^|\\s+)'+c+'(\\s+|$)');
					
					if ( element.className.search(pattern) < 0 ) {
						if ( !(action < 0) ) {
							element.className = element.className !== "" ? element.className + " " + c : c
							result = 1
						}
					} else {
						if ( !(action > 0) ) {
							element.className = element.className.replace(pattern, " ").trim()
							result = -1
						}
					}
				} else if ( !(action < 0) ) {
					element.className = c
					result = 1
				}
				
				return result;
			}
			
			function inflateParameters(result, string, leading, separator) {
				if ( string.charAt(0) === leading ) { string = string.slice(1) }
				
				var part, parts = string.split(separator)
				var object = result || {}
				
				for ( part of parts ) {
					var equals = part.indexOf("=")
					var value = (equals < 0) ? true : decodeURIComponent(part.slice(equals + 1))
					var key = equals < 0 ? part : part.slice(0, equals)
					
					object[key] = value
				}
				
				return object
			}
			
			function add(a, b) { return a + b }
			function subtract(a, b) { return a - b }
			
			function randomInteger(count) {
				if ( crypto && crypto.getRandomValues ) {
					var randomValues = new Uint32Array(1)
					
					crypto.getRandomValues(randomValues)
					
					return randomValues[0] % count
				} else {
					return Math.floor(Math.random() * Math.floor(count)) | 0
				}
			}
			
			function diceRoll(sides, diceToRoll, diceToKeep) {
				var rolls = []
				
				for ( var index = 0 ; index < diceToRoll ; ++index ) {
					rolls.push(1 + randomInteger(sides))
				}
				
				if ( diceToKeep > 0 && diceToKeep < diceToRoll ) {
					rolls = rolls.sort(subtract).slice(diceToRoll - diceToKeep)
				}
				
				return rolls
			}
			
			function handleDieRoll(sides) {
				var diceRolls = _element('tracking-dice-rolls')
				var diceCount = _element('tracking-dice-count')
				var diceSum = _element('tracking-dice-sum')
				
				if ( sides > 0 ) {
					var dieCount = diceCount.value || 1
					var rolls = diceRoll(sides, dieCount)
					var sum = rolls.reduce(add, 0)
					var summary = (dieCount > 1 ? dieCount : "") + "d" + sides + " (" + rolls.join(", ") + ")"
					
					if ( summary === diceRolls.innerHTML ) { summary = "• " + summary + " •" }
					
					diceRolls.innerHTML = summary
					diceSum.innerHTML = sum
				} else {
					diceCount.value = '1'
					diceRolls.innerHTML = ' '
					diceSum.innerHTML = ' '
				}
				
				diceCount.form.diceCount.value = diceCount.value
			}
			
			function handleMoreCombat(name, roll) {
				var parent = _element('tracking-combat-rolls')
				var children = parent.getElementsByClassName('tracking-combat-rolls-row hidden')
				
				if ( children.length > 0 ) {
					var element = children[0]
					
					_assignClass(element, 'hidden', -1)
					_element(element.id + '-name').value = name || ""
					_element(element.id + '-script').value = roll || ""
					_element(element.id + '-damage').value = ""
					_element(element.id + '-detail').value = ""
				}
				
				saveCombat()
			}
			
			function handleLessCombat(key) {
				if ( !key ) {
					var parent = _element('tracking-combat-rolls')
					var child, children = parent.getElementsByClassName('tracking-combat-rolls-row')
					
					for ( child of children ) {
						_assignClass(child, 'hidden', 1)
					}
					
					return
				}
				
				var element = _element(key)
				
				if ( element ) {
					_assignClass(element, 'hidden', 1)
					_assignClass(_element(element.id + '-result'), 'hidden', 1)
					_element(element.id + '-name').value = ""
					_element(element.id + '-script').value = ""
					_element(element.id + '-damage').value = ""
					_element(element.id + '-detail').value = ""
				}
				
				saveCombat()
			}
			
			function handleAttackRoll(prefix) {
				var script = _element(prefix + '-script')
				var target = _element('tracking-combat-rolls-target')
				
				var value = script.value
				
// 				var versus = evaluateRudimentaryDuel(value, false)
// 				
// 				if ( versus ) {
// 					output.value = ''
// 					detail.value = ''
// 					detail.innerHTML = "<ol start='0'><li>" + versus.join("</li><li>") + "</li></ol>"
// 					return
// 				}
				
				var where = value.indexOf('@')
				
				if ( target && where < 0 ) {
					var suffix = target.value
					
					if ( suffix.length > 0 && suffix.indexOf('@') < 0 ) { suffix = '@' + suffix }
					
					value = value + suffix
					where = value.indexOf('@')
				}
				
				var index = value.indexOf('%')
				var allowMontecarlo = where < 0 ? value.indexOf('/') === 0 && index > 0 : index > where
				var montecarlo = allowMontecarlo ? Math.min(+value.slice(index + 1) || 1000, 10000) : 0
				
				var parsed = parseAttackParameters(value, {})
				var damage = ""
				var detail = ""
				
				if ( parsed.length === 1 && !parsed[0].hit.length && !parsed[0].damage.length ) {
					_assignClass(_element(prefix + '-result'), 'hidden', 1)
					
					return
				}
				
				if ( montecarlo > 0 ) {
					var sum = 0
					var sample, samples = []
					
					for ( index = 0 ; index < montecarlo ; ++index ) {
						sample = evaluateEffectiveness(parsed, false)
						sum += sample.damage || 0
						
						if ( index < 10 ) { samples.push(sample.damage || 0) }
					}
					
					damage = (sum / montecarlo)
					detail = samples.join(", ") + (montecarlo > samples.length ? ", ... × " + montecarlo : "")
				} else {
					var result = evaluateEffectiveness(parsed, true)
					var entry, list = []
					var text, noDamage
					var isAttack = false
					
					for ( entry of result.summary ) {
						noDamage = entry.damage === false
						if ( entry.toHit !== false ) { isAttack = true }
						
						if ( entry.toHit === false ) {
							text = ""
						} else if ( entry.hit === false ) {
							text = "Miss (natural 1)"
							noDamage = true
						} else if ( entry.hit === true ) {
							text = "Hit (natural 20)"
						} else if ( !entry.armorClass ) {
							text = "Hits AC " + entry.hit + " (" + entry.toHit + (entry.bonusToHit < 0 ? "" : "+") + entry.bonusToHit + ")"
						} else if ( entry.isHit ) {
							text = "Hit (" + entry.toHit + (entry.bonusToHit < 0 ? "" : "+") + entry.bonusToHit + " hits by " + (entry.hit - entry.armorClass) + ")"
						} else {
							text = "Miss (" + entry.toHit + (entry.bonusToHit < 0 ? "" : "+") + entry.bonusToHit + " misses by " + (entry.armorClass - entry.hit) + ")"
							noDamage = true
						}
						
						if ( !noDamage ) {
							if ( text ) { text += " &bull; " }
							
							text += entry.damage + (entry.critical ? " critical" : "") + " damage"
						}
						
						list.push(text)
					}
					
					damage = isAttack ? result.damage === false ? "" : result.damage : result.damageRolled
					
					if ( list.length > 1 ) {
						detail = "<ol><li>" + list.join("</li><li>") + "</li><ol>"
					} else if ( isAttack ) {
						detail = list.join("")
					}
				}
				
				_element(prefix + '-damage').innerHTML = damage
				_element(prefix + '-detail').innerHTML = detail
				_assignClass(_element(prefix + '-result'), 'hidden', -1)
			}
			
			function handleAttackClose(prefix) {
				_assignClass(_element(prefix + '-result'), 'hidden', 1)
			}
			
			function replaceKeys(template, object) {
				var pattern = /\{([^ {}]+)\}/g
				
				return template.replace(pattern, function (match, key) { return object[key] })
			}
			
			function saveCombat() {
				var key = saveCombat.key
				var prefix = 'tracking-combat-rolls-'
				var array, entry, hide
				var index = 0
				var name, script, target = _element('tracking-combat-rolls-target')
				
				array = []
				array.push(target.value || "")
				
				while ( true ) {
					index += 1
					name = _element(prefix + index + '-name')
					script = _element(prefix + index + '-script')
					
					if ( !name || !script ) {
						break
					}
					
					if ( name.value || script.value ) {
						array.push([name.value || "", script.value || ""])
					}
				}
				
				window.localStorage.setItem(key, JSON.stringify(array))
			}
			
			function prepareStorageToSaveCombat(parameters) {
				var key
				var prefix = 'tracking-combat-rolls-'
				var array, entry
				var show, index
				var name, script, target = _element('tracking-combat-rolls-target')
				
				key = 'quickter.combat.scripts.' + (parameters.save || 'default')
				saveCombat.key = key
				
				array = window.localStorage.getItem(key)
				array = JSON.parse(array) || []
				
				if ( parameters.target ) {
					array[0] = parameters.target
				} else if ( array.length === 0 ) {
					array.push("")
				}
				
				if ( parameters.scripts ) {
					var names = new Object()
					
					for ( index = array.length ; index --> 1 ; ) {
						if ( array[index][0] ) {
							names[array[index][0]] = index
						}
					}
					
					for ( index = parameters.scripts.length ; index --> 0 ; ) {
						if ( names[parameters.scripts[index][0]] ) {
							array[names[parameters.scripts[index][0]]] = parameters.scripts[index]
							parameters.scripts.splice(index, 1)
						}
					}
					
					array.push.apply(array, parameters.scripts)
					window.localStorage.setItem(key, JSON.stringify(array))
				}
				
				target.value = array[0]
				
				index = 0
				while ( true ) {
					index += 1
					entry = array[index]
					name = _element(prefix + index + '-name')
					script = _element(prefix + index + '-script')
					
					if ( !name || !script ) {
						break
					}
					
					if ( Array.isArray(entry) ) {
						name.value = entry[0] || ""
						script.value = entry[1] || ""
						show = !!(entry[0] || entry[1])
					} else if ( typeof entry === 'string' ) {
						name.value = ""
						script.value = entry
						show = !!entry
					} else {
						show = false
					}
					
					_assignClass(_element(prefix + index), 'hidden', (show || index === 1) ? -1 : 1)
				}
			}
			
			function parseParameters(string) {
				var parameters = string || location.search
				if ( parameters.charAt(0) === '?' ) { parameters = parameters.slice(1) }
				
				var entry, array = parameters.split('&')
				var index, key, value
				
				var keys = ['save', 'target']
				var scripts = []
				var object = new Object()
				
				for ( entry of array ) {
					index = entry.indexOf('=')
					
					if ( index < 0 ) {
						if ( keys.indexOf(entry) < 0 ) {
							scripts.push(["", decodeURIComponent(entry)])
						} else {
							object[entry] = true
						}
					} else {
						key = entry.slice(0, index)
						value = decodeURIComponent(entry.slice(index + 1))
						
						if ( keys.indexOf(key) < 0 ) {
							scripts.push([decodeURIComponent(key), value])
						} else {
							object[key] = value
						}
					}
				}
				
				if ( scripts.length > 0 ) {
					object.scripts = scripts
				}
				
				return object
			}
			
			function populateCombatRolls() {
				var element = _element('tracking-combat-rolls')
				var index, maximumRolls = 12
				var rows = []
				var prefixRow = "<div>" +
					"<input type='button' id='tracking-combat-rolls-add' value='+' class='action' onclick='handleMoreCombat()' /><!-- label for='tracking-combat-add' class='action'><span>+</span></label -->" +
					"<label for='tracking-combat-rolls-add' class='combat action add'>+</label>" +
					//"<input id='toggle-combat-instructions' class='toggle' type='checkbox' /><label for='toggle-combat-instructions' class='toggle'> </label><div id='tracking-combat-instructions' class='toggled'></div>" +
					"</div>"
				var suffixRow = "<div class='tracking-combat-rolls-suffix'>" +
					"<span>@</span><input type='text' id='tracking-combat-rolls-target' value='' placeholder='16' class='tracking-combat-rolls-script' onchange='saveCombat()' />" +
					"</div>"
				var templateRow = "<div id='tracking-combat-rolls-{index}' class='tracking-combat-rolls-row combat-parent'>" +
					"<input type='button' id='tracking-combat-rolls-{index}-remove' value='-' class='action' onclick='handleLessCombat(\"tracking-combat-rolls-{index}\")' />" +
					"<label for='tracking-combat-rolls-{index}-remove' class='combat action remove'>-</label>" +
					"<input type='text' id='tracking-combat-rolls-{index}-name' value='' placeholder='Name' class='tracking-combat-rolls-name' onchange='saveCombat()' />" +
					"<input type='text' id='tracking-combat-rolls-{index}-script' value='' placeholder='+4/d8+2' class='tracking-combat-rolls-script' onchange='saveCombat()' />" +
					"<input type='button' id='tracking-combat-rolls-{index}-action' value='>' class='action' onclick='handleAttackRoll(\"tracking-combat-rolls-{index}\")' />" +
					"<label for='tracking-combat-rolls-{index}-action' class='combat action evaluate'>=</label>" +
					"<div id='tracking-combat-rolls-{index}-result' class='combat-result hidden' onclick='handleAttackClose(\"tracking-combat-rolls-{index}\")'>" +
						"<span id='tracking-combat-rolls-{index}-damage' class='combat-damage'></span>" +
						"<div id='tracking-combat-rolls-{index}-detail' class='combat-detail'></div>" +
					"</div>" +
					"</div>"
				
				for ( index = 0 ; index < maximumRolls ; ++index ) {
					rows.push(replaceKeys(templateRow, {'index':index + 1}))
				}
				
				element.innerHTML = prefixRow + rows.join(" ") + suffixRow
				//populateCombatInstructions()
			}
			
			function populatePage() {
				populateCombatRolls()
				prepareStorageToSaveCombat(parseParameters())
			}
		</script>
		
		<style>
			html {
				background: #EEE;
			}
			
			body {
				-webkit-font-smoothing: antialiased;
				-webkit-touch-callout: none;
				color: #555;
				background: #FFF;
				font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
				font-size: 14px;
				line-height: 1.75;
				padding: 2em;
				margin: 0 auto;
				max-width: 50em;
			}
			
			html { background-image: linear-gradient(270deg, rgb(230, 233, 233) 0%, rgb(216, 221, 221) 100%); }
			body { position:relative; box-shadow: 0 0 0.125em rgba(0, 0, 0, 0.06); }
			
			.hidden { display:none; }
			
			input.tracking-combat-rolls-name { max-width:50%; }
			input.tracking-combat-rolls-script { max-width:70%; }
			output.tracking-number-output { display:inline-block; min-width:2em; text-align:right; }
			#tracking-dice { font-size:180%; margin-bottom:2em; }
			#tracking-dice { display:flex; flex-wrap:wrap; align-items:center; justify-content:center; }
			#tracking-dice > div { min-width:50%; height:5em; text-align:center; margin-top:1em; }
			#tracking-dice-times { margin:0 0.75em 0 0.5em; }
			#tracking-dice-rolls { display:inline-block; color:#999; font-size:80%; }
			#tracking-dice-sum { display:inline-block; line-height:1.5; width:3em; height:1.75em; text-align:center; padding-top:0.25em; margin:0 1em; font-size:200%; font-weight:bold; color:#666; border-radius:50%; border:1px solid #CCC; }
			span.die-roll { display:inline-block; min-width:2.25em; text-align:center; }
			
			#tracking-combat-rolls > div { margin-bottom:1em; }
			#tracking-combat-rolls > div > input[type="text"] { font-size:150%; margin:0.25em 0.5em 0.25em 0; }
			#tracking-combat-rolls > div > input[type="text"]::placeholder { color:#CCC; }
			#tracking-combat-rolls > div > label.combat.action { font-size:150%; line-height:0.6em; padding-top:0.5em; padding-bottom:0.5em; text-align:center; }
			#tracking-combat-rolls > div > label.combat.action { margin-right:0.5em; display:inline-block; min-width:0.6em; }
			
			div.tracking-combat-rolls-suffix { display:none; }
			div.tracking-combat-rolls-suffix > span { color:#999; font-size:150%; margin-right:0.25em; }
			div.tracking-combat-rolls-row:not(.hidden) ~ div.tracking-combat-rolls-suffix { display:block; }
			div.tracking-combat-rolls-row > div.output { text-align:center; }
			div.tracking-combat-rolls-row > div.output > output:not(:empty) { font-size:150%; background:#F0F4F0; border:1px solid #DDD; padding:0.25em 0.5em; }
			
			div.combat-parent { position:relative; }
			div.combat-result { position:absolute; left:0; right:0; bottom:4em; width:30em; max-width:90%; border:4px solid #999; border-radius:2em; background:white; }
			div.combat-result { margin:0 auto; text-align:center; padding:2em 0; }
			div.combat-detail { margin-top:1em; }
			div.combat-detail > ol { display:inline-block; text-align:left; margin:0; padding-right:2em; }
			span.combat-damage:empty { display:none; }
			span.combat-damage { display:inline-block; line-height:1.5; width:3em; height:1.75em; text-align:center; padding-top:0.25em; margin:0 1em; font-size:200%; font-weight:bold; color:#666; border-radius:50%; border:1px solid #CCC; }
			
			@media print { div#navigation { display:none; } }
			div#navigation { position:absolute; left:1em; top:0.5em; }
			div#navigation a { text-decoration:none; display:inline-block; width:2em; height:1.875em; padding-top:0.125em; text-align:center; border-radius:50%; }
			div#navigation a#navigation-dice { background:#EEF; }
			
			input.action[type="button"] { display:none; }
			label.action:active { background-color:#EEE; }
			
			label.option, label.action {
				margin-right:0.5em;
				line-height:3.25;
				padding:0.75em;
				border-radius:0.5em;
				border:0.125em solid #CCC;
				white-space:nowrap;
				cursor:pointer;
			}
			
			.toggle, .roll, .action, .option {
				-webkit-tap-highlight-color:transparent;
			}
			
			.nose, .toggle, .roll, .action, .option {
				-webkit-touch-callout:none;
				-webkit-user-select:none;
				-moz-user-select:none;
				-ms-user-select:none;
				-o-user-select:none;
				user-select:none;
			}
		</style>
	</head>
	<body onload='populatePage()'>
		<div id='navigation'>
			<a id='navigation-bestiary' href='bestiary.html' title='Monster List'>🐉</a>
			<a id='navigation-spellbook' href='spellbook.html' title='Spell List'>📜</a>
			<a id='navigation-trove' href='trove.html' title='Magic Item List'>🔮</a>
			<a id='navigation-treasure' href='treasure.html' title='Roll Treasure'>💎</a>
			<a id='navigation-encounter' href='encounter.html' title='Roll Encounters'>🚪</a>
			<a id='navigation-dice' href='dice.html' title='Roll Dice'>🎲</a>
		</div>
		
		<h4>Dice</h4>
		
		<form id='tracking-dice-form'><div id='tracking-dice'>
			<span><input type='range' id='tracking-dice-count' value='1' min='1' max='20' oninput='form.diceCount.value = value' /><output for='tracking-dice-count' name='diceCount' class='tracking-number-output'>1</output></span>
			<span id='tracking-dice-times'>&times;</span>
			<span><input type='button' id='tracking-dice-d4' value='4' class='action' onclick='handleDieRoll(4)' /><label for='tracking-dice-d4' class='action'><span class='die-roll'>D4</span></label></span>
			<span><input type='button' id='tracking-dice-d6' value='6' class='action' onclick='handleDieRoll(6)' /><label for='tracking-dice-d6' class='action'><span class='die-roll'>D6</span></label></span>
			<span><input type='button' id='tracking-dice-d8' value='8' class='action' onclick='handleDieRoll(8)' /><label for='tracking-dice-d8' class='action'><span class='die-roll'>D8</span></label></span>
			<span><input type='button' id='tracking-dice-d10' value='10' class='action' onclick='handleDieRoll(10)' /><label for='tracking-dice-d10' class='action'><span class='die-roll'>D10</span></label></span>
			<span><input type='button' id='tracking-dice-d12' value='12' class='action' onclick='handleDieRoll(12)' /><label for='tracking-dice-d12' class='action'><span class='die-roll'>D12</span></label></span>
			<span><input type='button' id='tracking-dice-d20' value='20' class='action' onclick='handleDieRoll(20)' /><label for='tracking-dice-d20' class='action'><span class='die-roll'>D20</span></label></span>
			<span><input type='button' id='tracking-dice-d100' value='100' class='action' onclick='handleDieRoll(100)' /><label for='tracking-dice-d100' class='action'><span class='die-roll'>D100</span></label></span>
			<span><input type='button' id='tracking-dice-clear' value='0' class='action' onclick='handleDieRoll(0)' /><label for='tracking-dice-clear' class='action'><span class='die-roll'>Clear</span></label></span>
			<div>
				<span id='tracking-dice-sum'></span>
				<br /><span id='tracking-dice-rolls'></span>
			</div>
		</div></form>
		
		<hr />
		<h4>Combat</h4>
		<div id='tracking-combat-rolls'></div>
	</body>
</html>
