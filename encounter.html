<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Encounters</title>
		<meta name="author" content="Cole">
		<meta name="keywords" content="dnd,5e,dungeons,dragons,treasure">
		<meta name="description" content="Treasure">
		<script src="data/bestiary.js"></script>
		<script src="src/encounter.js"></script>
		
		<script type="text/javascript">
			'use strict';
			
			var encounter = {
				"experienceForChallengeRating":[
					10, 200, 450, 700, 1100, 1800, 2300, 2900, 3900, 5000, 5900,
					7200, 8400, 10000, 11500, 13000, 15000, 18000, 20000, 22000, 25000,
					33000, 41000, 50000, 62000, 75000, 90000, 105000, 120000, 135000, 155000
				],
				"difficulties":["easy", "medium", "hard", "deadly", "day"],
				"easy":   [0,  25,  50,   75,  125,  250,  300,  350,  450,  550,  600,   800,  1000,  1100,  1250,  1400,  1600,  2000,  2100,  2400,  2800],
				"medium": [0,  50, 100,  150,  250,  500,  600,  750,  900, 1100, 1200,  1600,  2000,  2200,  2500,  2800,  3200,  3900,  4200,  4900,  5700],
				"hard":   [0,  75, 150,  225,  375,  750,  900, 1100, 1400, 1600, 1900,  2400,  3000,  3400,  3800,  4300,  4800,  5900,  6300,  7300,  8500],
				"deadly": [0, 100, 200,  400,  500, 1100, 1400, 1700, 2100, 2400, 2800,  3600,  4500,  5100,  5700,  6400,  7200,  8800,  9500, 10900, 12700],
				"day":    [0, 300, 600, 1200, 1700, 3500, 4000, 5000, 6000, 7500, 9000, 10500, 11500, 13500, 15000, 18000, 20000, 25000, 27000, 30000, 40000],
				"multiplier":[{"m":0.5}, {"n":1, "m":1}, {"n":2, "m":1.5}, {"n":6, "m":2}, {"n":10, "m":2.5}, {"n":14, "m":3}, {"n":20, "m":4}, {"m":5}],
			}
			
			function _element(id) {
				if ( id && Node.ELEMENT_NODE === id.nodeType ) { return id }
				else if ( 'body' === id || 'head' === id ) { return document[id] }
				else { return document.getElementById(id) }
			}
			
			function _assignClass(element, c) {
				var result = 0;
				var action = ( arguments.length > 2 ) ? arguments[2] || 0 : 1
				
				if ( element.classList && 'function' === typeof element.classList.contains ) {
					if ( !(action > 0 || action < 0) ) {
						result = element.classList.toggle(c) ? 1 : -1
					} else if ( element.classList.contains(c) ) {
						result = !( action > 0 ) ? element.classList.remove(c) || -1 : 0
					} else {
						result = !( action < 0 ) ? element.classList.add(c) || 1 : 0
					}
				} else if ( element.className && 'function' === typeof element.className.search ) {
					var pattern = new RegExp('(^|\\s+)'+c+'(\\s+|$)');
					
					if ( element.className.search(pattern) < 0 ) {
						if ( !(action < 0) ) {
							element.className = element.className !== "" ? element.className + " " + c : c
							result = 1
						}
					} else {
						if ( !(action > 0) ) {
							element.className = element.className.replace(pattern, " ").trim()
							result = -1
						}
					}
				} else if ( !(action < 0) ) {
					element.className = c
					result = 1
				}
				
				return result;
			}
			
			function inflateParameters(result, string, leading, separator) {
				if ( string.charAt(0) === leading ) { string = string.slice(1) }
				
				var part, parts = string.split(separator)
				var object = result || {}
				
				for ( part of parts ) {
					var equals = part.indexOf("=")
					var value = (equals < 0) ? true : decodeURIComponent(part.slice(equals + 1))
					var key = equals < 0 ? part : part.slice(0, equals)
					
					object[key] = value
				}
				
				return object
			}
			
			function stripDiacriticals(string) {
				if ( typeof string.normalize === 'function' ) {
					return string.normalize('NFD').replace(/[\u0300-\u036f]/g, "")
				} else {
					return string.replace('é', 'e')
				}
			}
			
			function referenceKey(name) {
				return stripDiacriticals(name.toLowerCase()).replace(/(['‘’(){}×.,:]+|[-+ \t]+|\ba\s|\bof\s|\bthe\s)/g, '')
			}
			
			function resolveReferences(text, object) {
				text = text.replace(/\{=([^{}]+)\}/g, function (match, list) {
					var part = list.split('/'), key = part[0], value = object[key]
					
					if ( value && part.length > 1 ) {
						switch ( part[1] ) {
						case 'l': value = value.toLocaleLowerCase(); break
						case 'u': value = value.toLocaleUpperCase(); break
						case 'a': value = "a"; break
						case 'at': value = "A"; break
						}
					}
					
					return "<span class='property " + key + "'>" + (value || '-') + "</span>"
				})
				
				text = text.replace(/\{@([^{} ]+)\s+([^{}]+)\}/g, function (match, type, list) {
					var part = list.split('|')
					
					switch ( type ) {
					case "h": return "<span class='entries hit italic'>Hit: " + list + "</span> "
					case "recharge": return "<span class='entries recharge'>" + list + "</span>"
					case "b": case "bold": return "<span class='entries bold'>" + list + "</span>"
					case "i": case "italic": return "<span class='entries italic'>" + list + "</span>"
					case "dice": case "damage": return "<span class='entries " + type + " italic' onclick='handleDice(event, \"" + part[0] + "\")'>" + (part[1] || part[0]) + "</span>"
					case "chance": return "<span class='entries " + type + "' onclick='handleChance(event, \"" + part[0] + "\")'>" + (part[1] || part[0] + " percent") + "</span>"
					case "link": return "<span class='entries " + type + " italic'>" + list + "</span>"
					case "hit": return (+list < 0 ? "" : "+") + list
					case "atk": return "<span class='entries attack italic'>" + list.replace(/./g, function (l) { return (["Ranged", "Melee", "Spell", "Weapon", "or"]["rmsw,".indexOf(l)] || l) + " " }) + " Attack:</span> "
					case "dc": return list
					case "item": return "<a class='entries item' href='trove.html#" + referenceKey(part[0]) + "'>" + (part[2] || part[0]) + "</a>"
					case "spell": return "<a class='entries spell italic' href='spellbook.html#" + referenceKey(part[0]) + "'>" + (part[2] || part[0]) + "</a>"
					case "creature": return "<a class='entries creature' href='bestiary.html#" + referenceKey(part[0]) + "'>" + (part[2] || part[0]) + "</a>"
					case "hoard": return "<a class='entries hoard' href='treasure.html?k=h&n=1&p&r&c=" + (part[0] | 0) + "'>" + (part[2] || "Hoard") + "</a>"
					case "condition": case "skill": case "sense": case "action": case "hazard": return "<span class='entries " + type + "'>" + part[0] + "</span>"
					case "filter": return (part.length > 2 && part[1] === 'spells') ? "<a class='entries spell italic' href='spellbook.html?" + part[2] + "'>" + part[0] + "</a>" : "<span class='entries italic " + type + "'>" + part[0] + "</span>"
					case "adventure": return "<span class='entries italic " + type + "'>" + part[0] + "</span>"
					case "table": return "<span class='entries italic " + type + "'>" + (part[2] || part[0]) + "</span>"
					case "book": return "<span class='entries italic " + type + "'>" + (part[3] || part[0]) + "</span>"
					default: return "<span class='entries italic " + type + "'>" + (part[2] || part[0]) + "</span>"
					}
				})
				
				text = text.replace(/\{@h\}/g, "<span class='entries hit italic'>Hit:</span> ")
				text = text.replace(/\{@recharge\}/g, "<span class='entries recharge'></span>")
				
				return text
			}
			
			function challengeName(challenge) {
				return challenge > 0 && challenge < 1 ? "0⅛¼⅜½⅝¾⅞".charAt(Math.round(challenge * 8)) : challenge
			}
			
			function generateEncounterList(encounter, characterLevels, difficulties, environments, composition) {
				var difficulty, environment, repeat
				var limit, limits = encounterLimits(encounter, characterLevels)
				var index, count, prior, range, number, challenge, threshold, sum, creature
				var constraint, treasure, multiplier, group, key
				var rows = [], auxilaryRows = []
				
				for ( limit of limits ) {
					if ( !limit.uniformChallengeRatingForNumber ) {
						continue
					}
					
					if ( difficulties.length > 0 ) {
						if ( difficulties.indexOf(limit.difficulty) < 0 ) {
							continue
						}
					}
					
					switch ( composition ) {
					case 'uniform': repeat = 0; break
					case 'diverse': repeat = 2; break
					case 'none':    repeat = 0; break
					default:        repeat = 1; break
					}
					
					while ( repeat --> 0 ) {
						for ( index = 0, count = limit.multipliers.length ; index < count ; ++index ) {
							environment = encounterRandomEnvironment(encounter, environments)
							multiplier = limit.multipliers[index]
							threshold = multiplier.experience
							group = encounterRandomGroup(encounter, multiplier, environment)
							
							if ( !group && environments.indexOf(environment) < 0 ) {
								group = encounterRandomGroup(encounter, multiplier, 'all')
								environment = group.environment || "any"
							}
							
							if ( !group ) {
								continue
							}
							
							if ( group.lowerMaximum > group.lowerMinimum ) {
								sum = group.upperExperience * group.upperNumber
								sum = (sum + group.lowerExperience * group.lowerMinimum) + "-" + (sum + group.lowerExperience * group.lowerMaximum)
								range = group.lowerMinimum + "-" + group.lowerMaximum
							} else {
								sum = group.upperExperience * group.upperNumber + group.lowerExperience * group.lowerMinimum
								range = group.lowerMinimum
							}
							
							treasure = " {@hoard " + group.upperCreature.challenge + "||Hoard}"
							key = [group.upperCreature.key, group.lowerCreature.key].join('_')
							creature = " " + group.upperNumber + " &times; {@creature " + key + "||" + group.upperCreature.name + "} and " + group.lowerNumber + " &times; {@creature " + key + "||" + group.lowerCreature.name + "} &bull;"
							
							challenge = challengeName(group.lowerCreature.challenge)
							constraint = group.upperNumber + " &times; CR " + challengeName(group.upperCreature.challenge) + " and " + range + " &times; CR " + challenge + " (" + (false ? threshold + " <= " : "") + sum + (false ? " <= " + multiplier.experienceLimit : "") + " XP) "
							
							constraint = limit.difficulty + " " + constraint + environment + creature + treasure
							
							if ( rows.indexOf(constraint) < 0 ) {
								rows.push(constraint)
							}
						}
					}
					
					switch ( composition ) {
					case 'uniform': repeat = 2; break
					case 'diverse': repeat = 0; break
					case 'none':    repeat = 1; break
					default:        repeat = 1; break
					}
					
					while ( repeat --> 0 ) {
						prior = false
						
						for ( index = 1, count = limit.uniformChallengeRatingForNumber.length ; index < count ; ++index ) {
							number = index
							threshold = limit.experienceForNumber[number]
							challenge = limit.uniformChallengeRatingForNumber[number]
							
							if ( challenge === null ) {
								continue
							}
							
							if ( challenge === limit.uniformChallengeRatingForNumber[index + 1] ) {
								if ( !prior ) {
									prior = number
								}
								
								continue
							}
							
							sum = encounterExperienceSum(encounter, [challenge])
							sum = prior ? (prior * sum) + "-" + (index * sum) : (index * sum)
							environment = encounterRandomEnvironment(encounter, environments)
							
							if ( composition === 'none' ) {
								creature = false
							} else {
								creature = encounterRandomCreature(encounter, challenge, environment)
								
								if ( !creature && environments.indexOf(environment) < 0 ) {
									creature = encounterRandomCreature(encounter, challenge, 'all')
									environment = encounterRandomElement(creature.environments)
								}
							}
							
							treasure = " {@hoard " + challenge + "||Hoard}"
							challenge = challengeName(challenge)
							range = prior ? prior + "-" + index : ( index >= 15 && index + 1 == count ) ? index + "+" : index
							constraint = range + " &times; CR " + challenge + " (" + sum + (false ? " >= " + threshold : "") + " XP) "
							prior = false
							
							if ( creature ) {
								creature = creature ? " " + (prior ? prior + encounterRandomInteger(1 + index - prior) : index) + " &times; {@creature " + creature.name + "} &bull;" : ""
								constraint = limit.difficulty + " " + constraint + environment + creature + treasure
								
								if ( rows.indexOf(constraint) < 0 ) {
									rows.push(constraint)
								}
							} else {
								constraint = limit.difficulty + " " + constraint + environment + treasure
								
								if ( auxilaryRows.indexOf(constraint) < 0 ) {
									auxilaryRows.push(constraint)
								}
							}
						}
					}
				}
				
				if ( composition === 'none' ) {
					rows = auxilaryRows
				} else {
					var maximumEncounters = 10
					rows = encounterRandomElements(rows, maximumEncounters)
				
					if ( rows.length < maximumEncounters ) {
						rows = rows.concat(encounterRandomElements(auxilaryRows, maximumEncounters - rows.length))
					}
				}
				
				var html = "<ol class='encounters'>"
				
				html += "<li>" + rows.join("</li><li>") + "</li>"
				html += "</ol>"
				html = resolveReferences(html)
				html = html.replace(/_/g, ',')
				
				return html
			}
			
			function handleOptionChanged(event) {
				var encounter = window.encounter
				var form = _element('encounter-form')
				var characterLevels = form.level.value
				var difficulties = form.difficulty.value
				var environments = form.environment.value
				var composition = form.composition.value
				
				characterLevels = characterLevels ? characterLevels.split(/\D+/) : ['1']
				
				if ( difficulties === 'day' ) {
					var limits = encounterExperiencePerDifficulty(encounter, characterLevels)
					
					_element('encounter-list').textContent = "Roughly 6 - 8 encounters of medium to hard difficulty totalling " + limits[4] + " XP in the adventuring day."
					
					return
				}
				
				difficulties = difficulties ? difficulties.split(',') : []
				environments = environments ? environments.split(',') : []
				
				var html = generateEncounterList(encounter, characterLevels, difficulties, environments, composition)
				
				_element('encounter-list').innerHTML = html
			}
			
			function handleSubmit(event) {
				if ( event && typeof event.preventDefault === 'function' ) {
					event.preventDefault()
				}
				
				handleOptionChanged()
				
				return false
			}
			
			function applyParameters() {
				var hash = inflateParameters(null, location.hash, '#', '|')
				var object = inflateParameters(hash, location.search, '?', '&')
				var form = _element('encounter-form')
				var key, value
				
				value = object['l'] || object['character'] || object['level'] || ''
				if ( value ) { form.level.value = value }
				else { form.level.value = "1, 1, 1, 1" }
				
				value = object['d'] || object['difficulty'] || ''
				if ( value && value !== true && encounter.difficulties.indexOf(value) >= 0 ) { form.difficulty.value = value }
				
				value = object['e'] || object['environment'] || ''
				if ( value && value !== true && encounter.list.environments.indexOf(value) >= 0 ) { form.environment.value = value }
				
				value = object['c'] || object['composition'] || ''
				if ( value && value !== true && ['uniform', 'diverse', 'none'].indexOf(value) >= 0 ) { form.composition.value = value }
			}
			
			function populateSelect(element, groups) {
				var anyOption = "<option value=''>Any</option>"
				var templateGroup = "<optgroup label='{label}'>{options}</optgroup>"
				var templateOption = "<option value='{value}'>{name}</option>"
				var group, optionsGroups = []
				var option, options, list
				var rows = []
				
				for ( group of groups ) {
					list = group.options || [group]
					options = []
					
					for ( option of list ) {
						if ( typeof option === 'string' ) {
							options.push(templateOption.replace("{value}", option).replace("{name}", option))
						} else {
							options.push(templateOption.replace("{value}", option.value).replace("{name}", option.name || option.value))
						}
					}
					
					if ( typeof group.label === 'string' ) {
						rows.push(templateGroup.replace("{label}", group.label).replace("{options}", options.join("")))
					} else {
						rows.push.apply(rows, options)
					}
				}
				
				element = _element(element)
				element.innerHTML = anyOption + rows.join("")
			}
			
			function populateForm(encounter) {
				populateSelect('difficulty', [{'label':"Level", 'options':encounter.difficulties.slice(0, -1)}, {'label':"Group", 'options':encounter.difficulties.slice(-1)}])
				populateSelect('environment', [{'label':"Prime Material", 'options':encounter.list.commonEnvironments}, {'label':"Planar", 'options':encounter.list.syntheticEnvironments}])
				populateSelect('composition', [{'name':"Mixed Groups", 'value':'diverse'}, {'name':"Uniform Groups", 'value':'uniform'}, {'name':"Only Limits", 'value':'none'}])
				//populateSelect('group', ['1', '2', '3-6', '7-10', '11-14', '15+'])
			}
			
			function populatePage() {
				encounterIntegrateBestiary(encounter, bestiary)
				populateForm(encounter)
				applyParameters()
				handleSubmit()
			}
		</script>
		
		<style>
			html {
				background: #EEE;
			}
			
			body {
				-webkit-font-smoothing: antialiased;
				-webkit-touch-callout: none;
				color: #555;
				background: #FFF;
				font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
				font-size: 14px;
				line-height: 1.75;
				padding: 2em;
				margin: 0 auto;
				max-width: 50em;
			}
			
			html { background-image: linear-gradient(270deg, rgb(230, 233, 233) 0%, rgb(216, 221, 221) 100%); }
			body { position:relative; box-shadow: 0 0 0.125em rgba(0, 0, 0, 0.06); }
			
			div.options { display:inline-block; margin:0.5em; }
			div.options > span { display:block; }
			input.big-button { font-size:150%; border-radius:0.5em; border:3px solid #CCC; padding:0.5em 1.5em; background:#F8F8F8; }
			input.big-text { font-size:125%; }
			
			p#encounter-list a.entries { color:#036; text-decoration-color:#CCC; }
			p#encounter-list a.entries.hoard { color:#630; }
			
			p.explanation { font-size:80%; color:#999; }
			
			@media print {
				p.explanation { display:none; }
				form#encounter-form { display:none; }
			}
			
			.nose, .reroll {
				-webkit-touch-callout:none;
				-webkit-user-select:none;
				-moz-user-select:none;
				-ms-user-select:none;
				-o-user-select:none;
				user-select:none;
			}
		</style>
	</head>
	<body onload='populatePage()'>
		<h4>Encounter</h4>
		
		<form id='encounter-form' onsubmit="handleSubmit(); return false">
		
		<div class='options'><span>Character Levels</span><input type='text' id='level' name='level' placeholder='3, 3, 4, 4' /></div>
		<div class='options'><span>Difficulty</span><select id='difficulty' name='difficulty' onchange='handleOptionChanged()'></select></div>
		<div class='options'><span>Environment</span><select id='environment' name='environment' onchange='handleOptionChanged()'></select></div>
		<div class='options'><span>Composition</span><select id='composition' name='composition' onchange='handleOptionChanged()'></select></div>
		<div class='options'><input type='submit' class='big-button encounter' value='Roll' title='Generate random encounter' /></div>
		
		</form>
		
		<p id='encounter-list'></p>
		
		<p class='explanation'>Any creature can appear in a uniform group but only some travel in mixed groups.</p>
	</body>
</html>
